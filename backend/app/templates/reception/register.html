{% extends "reception/base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto mt-8">
  <h2 class="text-2xl font-bold text-green-700 mb-4">Register New Patient</h2>

  {% if error %}
    <div class="mb-4 rounded-md bg-red-50 p-3 text-red-700 text-sm">{{ error }}</div>
  {% endif %}

  <form method="post" action="/reception/register" class="bg-white rounded-xl border p-6 space-y-5" id="patientForm" novalidate>
    <div class="grid md:grid-cols-2 gap-4">

      <!-- Full Name -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Full Name<span class="text-red-500">*</span></label>
        <input name="name" required class="w-full border rounded-md px-3 py-2" value="{{ form_data.name or '' }}" autocomplete="off">
      </div>

      <!-- Phone -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Phone<span class="text-red-500">*</span></label>
        <input name="phone" required pattern="^\d{10}$" maxlength="10" inputmode="numeric"
               class="w-full border rounded-md px-3 py-2"
               value="{{ form_data.phone or '' }}"
               oninput="this.value=this.value.replace(/\\D/g,'').slice(0,10);" title="Enter exactly 10 digits">
      </div>

      <!-- Email -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Email <span class="text-red-500">*</span></label>
        <input name="email" required type="email" pattern="^[A-Za-z0-9._%+-]+@gmail\\.com$"
               class="w-full border rounded-md px-3 py-2"
               value="{{ form_data.email or '' }}" title="Must be a Gmail address like name@gmail.com">
      </div>

      <!-- Gender -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Gender<span class="text-red-500">*</span></label>
        <select name="gender" required class="w-full border rounded-md px-3 py-2">
          <option value="">Select</option>
          <option value="Male" {% if form_data.gender == 'Male' %}selected{% endif %}>Male</option>
          <option value="Female" {% if form_data.gender == 'Female' %}selected{% endif %}>Female</option>
          <option value="Other" {% if form_data.gender == 'Other' %}selected{% endif %}>Other</option>
        </select>
      </div>

      <!-- DOB -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Date of Birth<span class="text-red-500">*</span></label>
        <input name="dob" type="date" required class="w-full border rounded-md px-3 py-2"
               max="{{ today }}" value="{{ form_data.dob or '' }}">
        <p class="text-xs text-gray-500 mt-1">Future dates are not allowed.</p>
      </div>

      <!-- Weight -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Weight (kg)<span class="text-red-500">*</span></label>
        <input name="weight" required class="w-full border rounded-md px-3 py-2" value="{{ form_data.weight or '' }}">
      </div>

      <!-- Height -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Height<span class="text-red-500">*</span></label>
        <input name="height" required class="w-full border rounded-md px-3 py-2" value="{{ form_data.height or '' }}">
      </div>

      <!-- Doctor -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Assign Doctor<span class="text-red-500">*</span></label>
        <select name="assigned_doctor" required class="w-full border rounded-md px-3 py-2">
          <option value="">-- Select Doctor --</option>
          {% for d in doctors %}
            {% if d.status == 'approved' %}
              <option value="{{ d.name }}" {% if form_data.assigned_doctor == d.name %}selected{% endif %}>
                {{ d.name }} ({{ d.department or 'General' }})
              </option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Payment -->
    <div class="rounded-lg border border-green-200 bg-green-50 p-4">
      <div class="font-semibold text-green-800 mb-2">Payment (OP registration)</div>
      <div class="grid md:grid-cols-3 gap-3">
        <div>
          <label class="block text-sm text-gray-700">Mode<span class="text-red-500">*</span></label>
          <select name="payment_mode" required class="w-full border rounded-md px-3 py-2">
            <option value="">-- Select --</option>
            <option value="Cash" {% if form_data.payment_mode == 'Cash' %}selected{% endif %}>Cash</option>
            <option value="UPI" {% if form_data.payment_mode == 'UPI' %}selected{% endif %}>UPI</option>
            <option value="Card" {% if form_data.payment_mode == 'Card' %}selected{% endif %}>Card</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-700">Amount (â‚¹)<span class="text-red-500">*</span></label>
          <input name="payment_amount" required type="number" min="1" step="0.01"
                 class="w-full border rounded-md px-3 py-2" value="{{ form_data.payment_amount or '' }}">
        </div>
        <div>
          <label class="block text-sm text-gray-700">Reference (optional)</label>
          <input name="payment_ref" class="w-full border rounded-md px-3 py-2" value="{{ form_data.payment_ref or '' }}">
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-2">Reference is optional. All other fields are mandatory.</p>
    </div>

    <!-- Buttons -->
    <div class="flex gap-3">
      <a href="/reception/dashboard" class="px-4 py-2 rounded-md bg-gray-100 hover:bg-gray-200">Cancel</a>
      <button class="px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700">Register & Generate QR</button>
    </div>
  </form>
</div>

<script>
  // Prevent future DOBs
  (function() {
    const dob = document.querySelector('input[name="dob"]');
    if (dob) {
      const today = "{{ today }}";
      dob.addEventListener('change', () => {
        if (dob.value && dob.value > today) {
          alert('Date of birth cannot be in the future.');
          dob.value = today;
        }
      });
    }
  })();
</script>
{% endblock %}