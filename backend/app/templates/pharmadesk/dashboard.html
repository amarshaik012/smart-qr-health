{% extends "pharmadesk/base.html" %}
{% block content %}

<div class="max-w-5xl mx-auto bg-white shadow-lg rounded-2xl p-6 border border-blue-200">
  <h2 class="text-2xl font-bold text-blue-700 mb-6 flex items-center gap-2 justify-center">
    ğŸ¥ <span>PharmaDesk Dashboard</span>
  </h2>

  <!-- KPI Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center">
      <h3 class="text-sm font-semibold text-blue-800 mb-1">Patients</h3>
      <div class="text-3xl font-bold text-blue-700">{{ kpis.patients }}</div>
    </div>
    <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-center">
      <h3 class="text-sm font-semibold text-green-800 mb-1">Medicines</h3>
      <div class="text-3xl font-bold text-green-700">{{ kpis.medicines }}</div>
    </div>
    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-center">
      <h3 class="text-sm font-semibold text-yellow-800 mb-1">Dispenses</h3>
      <div class="text-3xl font-bold text-yellow-700">{{ kpis.dispenses }}</div>
    </div>
  </div>

  <!-- QR Scanner -->
  <div class="bg-gray-50 border border-gray-200 rounded-xl p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“· Scan Patient QR Code</h3>
    <p class="text-sm text-gray-600 mb-3 text-center">
      Use your camera to scan a patient's QR and open their prescription instantly.
    </p>

    <div id="reader" class="w-full rounded-lg overflow-hidden border border-gray-300 max-w-md mx-auto"></div>
    <p class="text-sm text-gray-500 text-center mt-2">
      ğŸ“¸ Allow camera access to scan QR codes.
    </p>

    <!-- Manual Entry -->
    <div class="mt-5 text-center">
      <label class="text-sm font-medium text-gray-700">Or enter manually:</label>
      <div class="flex flex-col sm:flex-row gap-2 justify-center mt-2">
        <input id="manualUID" type="text" placeholder="Enter patient UID..."
               class="border rounded px-3 py-2 flex-1 w-full sm:w-64" />
        <button onclick="openManual()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">
          Go
        </button>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
    <a href="/pharmadesk/inventory"
       class="bg-blue-600 text-white p-4 text-center rounded-lg hover:bg-blue-700 transition">
      ğŸ“¦ Manage Inventory
    </a>
    <a href="/pharmadesk/import"
       class="bg-green-600 text-white p-4 text-center rounded-lg hover:bg-green-700 transition">
      ğŸ“¥ Import Medicines
    </a>
    <a href="/pharmadesk/logout"
       class="bg-red-600 text-white p-4 text-center rounded-lg hover:bg-red-700 transition">
      ğŸšª Logout
    </a>
  </div>
</div>

<!-- âœ… QR Code Scanner Script -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
function openManual() {
  const uid = document.getElementById("manualUID").value.trim();
  if (uid) window.location.href = `/pharmadesk/prescription/${uid}`;
}

function onScanSuccess(decodedText) {
  try {
    let uid = decodedText;
    const m = decodedText.match(/\/p\/([A-Za-z0-9_-]+)/);
    if (m && m[1]) uid = m[1];
    if (!uid) return;
    window.location.href = `/pharmadesk/prescription/${uid}`;
  } catch (e) {
    console.error(e);
  }
}

function onScanError(err) {
  console.warn("QR scan error:", err);
}

// Initialize scanner after DOM ready
document.addEventListener("DOMContentLoaded", () => {
  const readerElem = document.getElementById("reader");
  const reader = new Html5Qrcode("reader");

  Html5Qrcode.getCameras()
    .then((cams) => {
      if (!cams || !cams.length) {
        readerElem.innerHTML = "<div class='text-center text-red-600'>âŒ No camera found.</div>";
        return;
      }
      const camId = cams[0].id;
      reader.start(camId, { fps: 10, qrbox: 250 }, onScanSuccess, onScanError);
    })
    .catch((err) => {
      readerElem.innerHTML = `<div class='text-center text-red-600'>ğŸš« Camera access denied: ${err}</div>`;
    });
});
</script>

{% endblock %}