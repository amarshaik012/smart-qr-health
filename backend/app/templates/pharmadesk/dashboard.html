{% extends "pharmadesk/base.html" %}
{% block content %}

<div class="bg-white shadow-lg rounded-2xl p-6 max-w-4xl mx-auto border border-green-200">
  <h2 class="text-2xl font-bold text-green-700 mb-6 text-center">
    🏥 PharmaDesk Dashboard
  </h2>

  <!-- 📊 Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-gradient-to-r from-green-100 to-green-200 shadow rounded-xl p-5 text-center border border-green-300">
      <p class="text-green-800 font-medium text-sm">Dispensed Today</p>
      <h2 class="text-4xl font-extrabold text-green-700 mt-1">{{ dispensed_today }}</h2>
    </div>

    <div class="bg-gradient-to-r from-blue-100 to-blue-200 shadow rounded-xl p-5 text-center border border-blue-300">
      <p class="text-blue-800 font-medium text-sm">Total Dispensed</p>
      <h2 class="text-4xl font-extrabold text-blue-700 mt-1">{{ total_dispensed }}</h2>
    </div>
  </div>

  <!-- 🧾 UID Entry Section -->
  <div class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
    <h3 class="text-xl font-semibold mb-4 text-green-700">🔍 Scan QR or Enter Patient UID</h3>

    <!-- Manual UID Entry -->
    <form action="/pharmadesk/resolve" method="post" class="flex flex-col sm:flex-row gap-3 mb-6">
      <input
        name="uid"
        placeholder="Enter Patient UID (e.g., ZKzsvsJ4LoFL)"
        class="flex-1 border border-green-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-400 outline-none"
        required
      />
      <button
        class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition font-medium">
        Open
      </button>
    </form>

    <!-- QR Scanner Section -->
    <div class="space-y-2">
      <div id="reader" class="w-full rounded-lg overflow-hidden border border-green-300"></div>
      <p class="text-sm text-gray-600 text-center">
        📸 Allow camera access to scan the patient's QR code.
      </p>
    </div>
  </div>
</div>

<!-- QR Scanner Script -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  function onScanSuccess(decodedText, decodedResult) {
    try {
      let uid = decodedText;
      const m = decodedText.match(/\/p\/([A-Za-z0-9_-]+)/);
      if (m && m[1]) uid = m[1];
      if (!uid) return;
      window.location.href = `/pharmadesk/prescription/${uid}`;
    } catch (e) {
      console.error(e);
    }
  }

  function onScanError(err) {}

  const reader = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cams => {
    const camId = cams && cams.length ? cams[0].id : null;
    if (!camId) return;
    reader.start(camId, { fps: 10, qrbox: 250 }, onScanSuccess, onScanError);
  }).catch(console.error);
</script>

{% endblock %}