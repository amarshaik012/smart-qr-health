{% extends "pharmadesk/base.html" %}
{% block content %}

<div class="max-w-5xl mx-auto bg-white shadow-lg rounded-2xl p-6 border border-green-200">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-bold text-green-700">ğŸ’Š Dispense & Bill</h2>
    <a href="/pharmadesk/dashboard" class="text-sm text-green-700 hover:underline">â† Back</a>
  </div>

  {% if request.query_params.get('bill') %}
  <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-2 rounded mb-4 flex items-center justify-between">
    <span>âœ… Dispensed successfully. Bill is ready.</span>
    <a class="px-3 py-1 rounded bg-green-600 text-white" href="/pharmadesk/bill/{{ request.query_params.get('bill') }}" target="_blank">â¬‡ï¸ Open Invoice</a>
  </div>
  {% endif %}

  {% if error %}
  <div class="bg-red-100 border border-red-300 text-red-800 px-4 py-2 rounded mb-4">{{ error }}</div>
  {% endif %}

  <!-- Patient Info -->
  <div class="bg-green-50 p-4 rounded-xl border border-green-200 mb-6">
    <h3 class="font-semibold text-green-800 mb-2">ğŸ‘¤ Patient</h3>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm text-gray-800">
      <div><span class="font-medium">Name:</span> {{ patient.name }}</div>
      <div><span class="font-medium">UID:</span> {{ patient.patient_uid }}</div>
      <div><span class="font-medium">Status:</span>
        {% if patient.status == 'dispensed' %}
        <span class="px-2 py-1 rounded bg-green-100 text-green-800 text-xs">Dispensed</span>
        {% elif patient.status == 'done' %}
        <span class="px-2 py-1 rounded bg-blue-100 text-blue-800 text-xs">Ready</span>
        {% else %}
        <span class="px-2 py-1 rounded bg-yellow-100 text-yellow-800 text-xs">{{ patient.status or 'Waiting' }}</span>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Prescription -->
  <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 mb-8">
    <h3 class="font-semibold text-blue-800 mb-2">ğŸ©º Latest Prescription</h3>
    {% if prescription %}
    <div class="text-sm text-gray-800 mb-2">
      <div><span class="font-medium">Diagnosis:</span> {{ prescription.Diagnosis }}</div>
      <div class="mt-2"><span class="font-medium">Doctor Notes:</span> {{ prescription.Notes or '-' }}</div>
    </div>
    <p class="text-xs text-gray-600 mt-1">ğŸ’¡ Items automatically loaded below from doctor's prescription.</p>
    {% else %}
    <div class="bg-yellow-50 border border-yellow-300 text-yellow-800 px-4 py-2 rounded">
      âš ï¸ No prescriptions found for this patient yet.
    </div>
    {% endif %}
  </div>

  <!-- Dispense Builder -->
  <div class="bg-white border rounded-xl p-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="font-semibold text-gray-800">ğŸ§¾ Dispense Items</h3>
      <button id="recalcBtn" class="text-xs bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">ğŸ” Recalculate Total</button>
    </div>

    <div class="overflow-x-auto mb-6">
      <table class="min-w-full text-sm" id="linesTable">
        <thead class="bg-gray-50 sticky top-0">
          <tr>
            <th class="p-2 text-left">Item</th>
            <th class="p-2 text-right">Stock</th>
            <th class="p-2 text-right">Qty</th>
            <th class="p-2 text-right">Unit â‚¹</th>
            <th class="p-2 text-right">Disc %</th>
            <th class="p-2 text-right">Tax %</th>
            <th class="p-2 text-right">Line Total â‚¹</th>
          </tr>
        </thead>
        <tbody id="lineBody"></tbody>
        <tfoot class="bg-green-50">
          <tr>
            <td colspan="6" class="p-2 text-right font-semibold">Grand Total</td>
            <td class="p-2 text-right font-bold" id="grandTotal">â‚¹0.00</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- âœ… Form -->
    <form id="dispenseForm" method="post" action="/pharmadesk/dispense/{{ patient.patient_uid }}" class="mt-4 flex flex-wrap gap-3 justify-end">
      <input type="hidden" name="items_json" id="items_json" />
      <input type="text" name="pharmacist" placeholder="Pharmacist name" class="border rounded px-3 py-2" value="pharmadesk" />
      <select name="payment_mode" class="border rounded px-3 py-2">
        <option value="Cash">Cash</option>
        <option value="Card">Card</option>
        <option value="UPI">UPI</option>
      </select>
      <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">âœ… Dispense</button>
    </form>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const lineBody = $("#lineBody");
const grandTotalEl = $("#grandTotal");
const itemsHidden = $("#items_json");

function money(n){ return "â‚¹" + (Number(n||0).toFixed(2)); }

// âœ… include medicine_id in data attributes
function addLine(m, qty = 1) {
  const tr = document.createElement("tr");
  const stockWarn = m.stock_qty <= qty ? 'âš ï¸ Low Stock' : '';
  tr.className = "border-b";
  tr.dataset.mid = m.id; // store medicine id
  tr.innerHTML = `
    <td class="p-2">${m.label} ${stockWarn ? `<span class='text-xs text-red-600 ml-1'>${stockWarn}</span>` : ''}</td>
    <td class="p-2 text-right">${m.stock_qty}</td>
    <td class="p-2 text-right">${qty}</td>
    <td class="p-2 text-right">${m.mrp.toFixed(2)}</td>
    <td class="p-2 text-right"><input type="number" step="0.01" value="0" class="disc w-20 border rounded px-2 py-1 text-right"></td>
    <td class="p-2 text-right">${m.tax_pct.toFixed(1)}</td>
    <td class="p-2 text-right total">â‚¹0.00</td>
  `;
  lineBody.appendChild(tr);
  tr.querySelector(".disc").addEventListener("input", recalc);
  recalc();
}

function recalc() {
  let g = 0;
  $$("#lineBody tr").forEach(tr => {
    const qty = Number(tr.children[2].textContent);
    const unit = parseFloat(tr.children[3].textContent);
    const disc = parseFloat(tr.querySelector(".disc").value || 0);
    const tax  = parseFloat(tr.children[5].textContent);
    const subtotal = unit * qty;
    const afterDisc = subtotal * (1 - (disc/100));
    const total = afterDisc * (1 + (tax/100));
    tr.querySelector(".total").textContent = money(total);
    g += total;
  });
  grandTotalEl.textContent = money(g);

  // âœ… include medicine_id in payload
  const payload = $$("#lineBody tr").map(tr => ({
    medicine_id: Number(tr.dataset.mid || 0),
    label: tr.children[0].textContent.replace('âš ï¸ Low Stock','').trim(),
    qty: Number(tr.children[2].textContent),
    unit_price: Number(tr.children[3].textContent),
    discount_pct: Number(tr.querySelector(".disc").value || 0),
    tax_pct: Number(tr.children[5].textContent)
  }));
  itemsHidden.value = JSON.stringify(payload);
}

async function prefillFromPrescription() {
  const meds = {{ prescription.Medicines | tojson | safe }};
  for (const it of meds) {
    const name = it.name || it.label;
    const res = await fetch(`/pharmadesk/api/medicines?q=${encodeURIComponent(name)}`);
    const list = await res.json();
    if (list.length > 0) addLine(list[0], it.qty || 1);
  }
}

$("#recalcBtn").addEventListener("click", recalc);
document.addEventListener("DOMContentLoaded", prefillFromPrescription);

// âœ… Ensure recalc before submit
document.querySelector("#dispenseForm").addEventListener("submit", (e) => {
  recalc();
  console.log("Submitting form with:", document.querySelector("#items_json").value);
});

// âœ… Auto open invoice on success
if (new URLSearchParams(window.location.search).get("bill")) {
  const billId = new URLSearchParams(window.location.search).get("bill");
  setTimeout(() => {
    window.open(`/pharmadesk/bill/${billId}`, "_blank");
  }, 800);
}
</script>

{% endblock %}